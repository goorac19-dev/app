<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Goorac | Quantum Calls</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg: #0b141a;
            --accent: #00d2ff; 
            --border: rgba(255, 255, 255, 0.1);
            --text-dim: #888; 
            --danger: #ff4444; 
            --success: #1ebea5;
            --ig-blue: #0095f6;
        }

        body {
            background: #000; color: white; margin: 0;
            font-family: -apple-system, system-ui, sans-serif;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            -webkit-user-select: none;
            user-select: none;
        }

        input { -webkit-user-select: text; user-select: text; }

        header { padding: 15px 20px 5px; border-bottom: 1px solid var(--border); background: #000; }
        .header-logo { font-weight: 900; font-size: 1.4rem; color: var(--accent); letter-spacing: 1px; }
        .search-box { padding: 10px 0; }
        .search-box input { width: 100%; background: #111; border: 1px solid var(--border); padding: 12px; border-radius: 12px; color: white; outline: none; box-sizing: border-box; }
        .tabs { display: flex; gap: 20px; }
        .tab { font-size: 0.85rem; font-weight: 600; color: var(--text-dim); cursor: pointer; padding-bottom: 8px; position: relative; }
        .tab.active { color: var(--accent); }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--accent); }

        #list-container { flex: 1; overflow-y: auto; padding-bottom: 80px; -webkit-overflow-scrolling: touch; }

        /* Skeleton */
        .skeleton { background: linear-gradient(90deg, #111 25%, #222 50%, #111 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 4px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-item { display: flex; align-items: center; padding: 15px 20px; gap: 15px; }
        .sk-pfp { width: 50px; height: 50px; border-radius: 50%; }
        .sk-text { height: 12px; width: 60%; margin-bottom: 8px; }

        .call-item { display: flex; align-items: center; padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .call-pfp { width: 52px; height: 52px; border-radius: 50%; margin-right: 15px; object-fit: cover; background: #222; }
        .call-info { flex: 1; }
        .u-name { font-weight: 600; font-size: 1rem; display: flex; align-items: center; gap: 4px; margin-bottom: 2px; }
        
        .v-badge { 
            width: 14px; height: 14px; background-color: var(--ig-blue);
            -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22.5 12.5c0-1.58.8-3.04 2.12-4.03l-1.1-2.48-2.74.05a4.95 4.95 0 0 1-4.04-2.12L14.24 3l-2.47 1.1-1.1-2.48-2.5.78L7.1 5.14a4.95 4.95 0 0 1-4.04 2.12l-2.74-.05-1.1 2.48 2.12 4.03-2.12 4.03 1.1 2.48 2.74-.05a4.95 4.95 0 0 1 4.04 2.12L9.76 21l2.47-1.1 1.1 2.48 2.5-.78.78-2.73a4.95 4.95 0 0 1 4.04-2.12l2.74.05 1.1-2.48-2.12-4.03Z"/></svg>') center/contain no-repeat;
            display: flex; align-items: center; justify-content: center;
        }
        .v-badge::after { content: '‚úì'; color: white; font-size: 9px; font-weight: 900; }

        .call-meta { font-size: 0.8rem; color: var(--text-dim); }
        .status-missed { color: var(--danger); }
        .status-incoming { color: var(--success); }
        .status-outgoing { color: var(--accent); }
        .btn-call { width: 40px; height: 40px; border-radius: 50%; border: none; background: rgba(0, 210, 255, 0.1); color: var(--accent); font-size: 1.1rem; }

        /* Call Screen */
        #call-screen {
            position: fixed; inset: 0; background: #0b141a; z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: space-between; padding: 60px 20px 50px;
        }
        #remote-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; display: none; }
        #local-video { position: absolute; top: 40px; right: 20px; width: 100px; height: 150px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); object-fit: cover; z-index: 10; display: none; background: #000; }
        
        .call-header { z-index: 5; text-align: center; }
        .call-header h2 { font-size: 1.8rem; margin: 0 0 10px; font-weight: 400; display: flex; align-items: center; justify-content: center; gap: 8px; }
        #call-status { font-size: 0.85rem; color: #aebac1; letter-spacing: 2px; }
        #call-timer { font-size: 1.1rem; margin-top: 10px; display: none; }

        .call-body { z-index: 5; flex: 1; display: flex; align-items: center; justify-content: center; width: 100%; transition: opacity 0.5s; }
        #target-pfp { width: 180px; height: 180px; border-radius: 50%; object-fit: cover; border: 4px solid rgba(255,255,255,0.05); }
        .pulse { position: absolute; width: 180px; height: 180px; border-radius: 50%; border: 2px solid var(--accent); animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0% { transform: scale(1); opacity: 0.6; } 100% { transform: scale(1.6); opacity: 0; } }

        .call-controls { z-index: 20; width: 100%; display: flex; flex-direction: column; gap: 25px; align-items: center; }
        .control-row { display: flex; gap: 20px; justify-content: center; width: 100%; }
        .ctrl-btn { width: 55px; height: 55px; border-radius: 50%; border: none; font-size: 1.3rem; background: rgba(255,255,255,0.1); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-end { background: var(--danger) !important; width: 65px; height: 65px; }
        .btn-accept { background: var(--success) !important; width: 65px; height: 65px; }
        .btn-off { background: white !important; color: black !important; }

        nav { position: fixed; bottom: 0; width: 100%; background: #000; display: flex; justify-content: space-around; padding: 15px 0 25px; border-top: 1px solid var(--border); z-index: 100; }
        .nav-icon { font-size: 1.5rem; color: #555; text-decoration: none; }
        .nav-icon.active { color: var(--accent); }
    </style>
</head>
<body oncontextmenu="return false;">

<audio id="ringtone" loop><source src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" type="audio/mpeg"></audio>
<audio id="dialtone" loop><source src="https://www.soundjay.com/phone/sounds/phone-calling-1.mp3" type="audio/mpeg"></audio>

<header>
    <div class="header-logo">GOORAC</div>
    <div class="search-box">
        <input type="text" id="search" placeholder="Search contacts or history..." autocomplete="off">
    </div>
    <div class="tabs">
        <div class="tab active" id="tab-recent" onclick="switchTab('recent')">Recent</div>
        <div class="tab" id="tab-contacts" onclick="switchTab('contacts')">Contacts</div>
    </div>
</header>

<div id="list-container"></div>

<div id="call-screen">
    <video id="remote-video" autoplay playsinline></video>
    <video id="local-video" autoplay playsinline muted></video>
    
    <div class="call-header">
        <h2 id="target-name">User</h2>
        <p id="call-status">CONNECTING...</p>
        <div id="call-timer">00:00</div>
    </div>

    <div class="call-body" id="pfp-area">
        <div style="position: relative; display: flex; align-items: center; justify-content: center;">
            <div class="pulse" id="ring-animation"></div>
            <img src="" id="target-pfp">
        </div>
    </div>

    <div class="call-controls">
        <div class="control-row">
            <button class="ctrl-btn" id="mic-btn" onclick="toggleMic()">üéôÔ∏è</button>
            <button class="ctrl-btn" id="cam-btn" onclick="toggleCam()">üì∑</button>
            <button class="ctrl-btn" id="speaker-btn" onclick="toggleSpeaker()">üîä</button>
        </div>
        <div class="control-row">
            <button class="ctrl-btn btn-accept" id="answer-btn" style="display:none;" onclick="answerCall()">üìû</button>
            <button class="ctrl-btn btn-end" id="hangup-btn" onclick="hangUp()">üìû</button>
        </div>
    </div>
</div>

<nav>
    <a href="home.html" class="nav-icon">üè†</a>
    <a href="messages.html" class="nav-icon">üí¨</a>
    <a href="add-contact.html" class="nav-icon">üîç</a>
    <a href="calls.html" class="nav-icon active">üìû</a>
</nav>

<script>
    // Security
    document.addEventListener('keydown', e => {
        if (e.ctrlKey && ['c','v','u','s','a','p'].includes(e.key)) e.preventDefault();
        if (e.key === 'F12') e.preventDefault();
    });

    const firebaseConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
        databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const rdb = firebase.database();
    const auth = firebase.auth();

    let myUid, myData, pc, localStream, timerInterval;
    let currentCallId = null;
    let isCaller = false;
    let secondsElapsed = 0;
    let currentActiveTarget = null; 
    let activeTab = 'recent';
    let isCamOn = false;
    let cachedList = [];

    const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

    auth.onAuthStateChanged(async user => {
        if (user) {
            myUid = user.uid;
            const doc = await db.collection("users").doc(myUid).get();
            myData = doc.data() || {};
            loadData();
            listenForPings();
        } else { window.location.href = 'login.html'; }
    });

    function switchTab(tab) {
        if (activeTab === tab) return;
        activeTab = tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.add('active');
        loadData();
    }

    async function loadData() {
        showSkeleton();
        if (activeTab === 'recent') await loadRecent(); else await loadContacts();
    }

    function showSkeleton() {
        const container = document.getElementById('list-container');
        container.innerHTML = Array(6).fill(`<div class="skeleton-item"><div class="sk-pfp skeleton"></div><div style="flex:1"><div class="sk-text skeleton"></div><div class="sk-text skeleton" style="width:30%"></div></div></div>`).join('');
    }

    async function loadRecent() {
        const snap = await db.collection("call_logs").where('participants', 'array-contains', myUid).orderBy('timestamp', 'desc').limit(15).get();
        cachedList = await Promise.all(snap.docs.map(async doc => {
            const call = doc.data();
            const isOut = call.callerId === myUid;
            const otherUid = isOut ? call.receiverId : call.callerId;
            const uDoc = await db.collection("users").doc(otherUid).get();
            const u = uDoc.data() || {};
            
            let status = (call.status === 'completed') ? (isOut ? "Outgoing" : "Incoming") : (isOut ? "Cancelled" : "Missed");
            return {
                uid: otherUid,
                name: u.name || "User",
                pfp: u.photoURL,
                verified: u.verified,
                statusClass: (status === "Missed" || status === "Cancelled") ? "status-missed" : (isOut ? "status-outgoing" : "status-incoming"),
                metaText: `${status} ‚Ä¢ ${call.duration} ‚Ä¢ ${new Date(call.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`
            };
        }));
        renderList();
    }

    async function loadContacts() {
        const following = myData.following || [];
        const results = await Promise.all(following.map(async uid => {
            const uDoc = await db.collection("users").doc(uid).get();
            const u = uDoc.data();
            if (u && u.following?.includes(myUid)) {
                return { uid, name: u.name, pfp: u.photoURL, verified: u.verified, metaText: `@${u.username}` };
            }
            return null;
        }));
        cachedList = results.filter(c => c !== null);
        renderList();
    }

    function renderList(query = '') {
        const list = document.getElementById('list-container');
        const filtered = cachedList.filter(i => i.name.toLowerCase().includes(query.toLowerCase()));
        list.innerHTML = filtered.map(item => `
            <div class="call-item">
                <img src="${item.pfp || 'https://via.placeholder.com/150'}" class="call-pfp">
                <div class="call-info">
                    <div class="u-name">${item.name} ${item.verified ? '<span class="v-badge"></span>' : ''}</div>
                    <div class="call-meta ${item.statusClass || ''}">${item.metaText}</div>
                </div>
                <button class="btn-call" onclick="startCall('${item.uid}', '${item.name}', '${item.pfp}', ${item.verified})">üìû</button>
            </div>
        `).join('') || `<p style="text-align:center; padding:40px; opacity:0.5;">No items found</p>`;
    }

    document.getElementById('search').addEventListener('input', e => renderList(e.target.value));

    async function startCall(targetUid, name, pfp, verified) {
        isCaller = true;
        currentActiveTarget = { uid: targetUid, name, pfp, verified };
        currentCallId = "call_" + [myUid, targetUid].sort().join("_");
        
        showCallUI(name, pfp, "DIALING...", verified);
        document.getElementById('dialtone').play().catch(()=>{});

        try {
            localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            document.getElementById('local-video').srcObject = localStream;
            localStream.getVideoTracks().forEach(t => t.enabled = false);
            
            setupPeerConnection(targetUid);
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            
            await rdb.ref(`calls/${currentCallId}`).set({
                offer: { sdp: offer.sdp, type: offer.type },
                caller: myUid, status: 'ringing', timestamp: Date.now()
            });

            await rdb.ref(`signaling/${targetUid}`).set({
                from: myUid, callId: currentCallId, name: myData.name, pfp: myData.photoURL, verified: myData.verified || false, timestamp: Date.now()
            });

            rdb.ref(`calls/${currentCallId}`).on('value', snap => {
                const data = snap.val();
                if (!data) return;
                if (['declined', 'ended', 'cancelled'].includes(data.status)) hangUp(true);
                if (data.answer && !pc.currentRemoteDescription) {
                    document.getElementById('dialtone').pause();
                    pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    startTimer();
                }
            });
        } catch (e) { alert("Mic/Cam access required"); hangUp(); }
    }

    function listenForPings() {
        rdb.ref(`signaling/${myUid}`).on('value', snap => {
            const data = snap.val();
            if (data && !currentCallId && (Date.now() - data.timestamp < 30000)) {
                isCaller = false;
                currentCallId = data.callId;
                currentActiveTarget = { uid: data.from, name: data.name, pfp: data.pfp, verified: data.verified };
                showCallUI(data.name, data.pfp, "INCOMING CALL...", data.verified);
                document.getElementById('answer-btn').style.display = 'flex';
                document.getElementById('ringtone').play().catch(()=>{});
                
                rdb.ref(`calls/${currentCallId}/status`).on('value', s => {
                    if (['cancelled', 'ended'].includes(s.val())) hangUp(true);
                });
            }
        });
    }

    async function answerCall() {
        document.getElementById('ringtone').pause();
        document.getElementById('answer-btn').style.display = 'none';
        try {
            localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            document.getElementById('local-video').srcObject = localStream;
            localStream.getVideoTracks().forEach(t => t.enabled = false);

            const snap = await rdb.ref(`calls/${currentCallId}`).get();
            setupPeerConnection(currentActiveTarget.uid);
            await pc.setRemoteDescription(new RTCSessionDescription(snap.val().offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await rdb.ref(`calls/${currentCallId}`).update({ answer: { sdp: answer.sdp, type: answer.type }, status: 'connected' });
            rdb.ref(`signaling/${myUid}`).remove();
            startTimer();
        } catch (e) { hangUp(); }
    }

    function setupPeerConnection(targetUid) {
        pc = new RTCPeerConnection(servers);
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.onicecandidate = e => e.candidate && rdb.ref(`calls/${currentCallId}/candidates/${myUid}`).push(e.candidate.toJSON());
        pc.ontrack = e => {
            const rv = document.getElementById('remote-video');
            rv.srcObject = e.streams[0];
            const vt = e.streams[0].getVideoTracks()[0];
            vt.onmute = () => { rv.style.display = 'none'; document.getElementById('pfp-area').style.opacity = '1'; };
            vt.onunmute = () => { rv.style.display = 'block'; document.getElementById('pfp-area').style.opacity = '0'; };
        };
        rdb.ref(`calls/${currentCallId}/candidates/${targetUid}`).on('child_added', s => pc.addIceCandidate(new RTCIceCandidate(s.val())));
    }

    function startTimer() {
        document.getElementById('call-status').innerText = "CONNECTED";
        document.getElementById('call-status').style.color = "var(--success)";
        document.getElementById('ring-animation').style.display = 'none';
        document.getElementById('call-timer').style.display = 'block';
        secondsElapsed = 0;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            secondsElapsed++;
            const m = String(Math.floor(secondsElapsed/60)).padStart(2,'0');
            const s = String(secondsElapsed%60).padStart(2,'0');
            document.getElementById('call-timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    async function hangUp(remoteEnded = false) {
        document.getElementById('ringtone').pause();
        document.getElementById('dialtone').pause();
        
        if (currentCallId && !remoteEnded) {
            let status = secondsElapsed > 0 ? 'ended' : (isCaller ? 'cancelled' : 'declined');
            await rdb.ref(`calls/${currentCallId}/status`).set(status);
            
            await db.collection("call_logs").add({
                participants: [myUid, currentActiveTarget.uid],
                callerId: isCaller ? myUid : currentActiveTarget.uid,
                receiverId: isCaller ? currentActiveTarget.uid : myUid,
                status: secondsElapsed > 0 ? 'completed' : status,
                duration: document.getElementById('call-timer').innerText,
                timestamp: Date.now()
            });
        }

        if (localStream) localStream.getTracks().forEach(t => t.stop());
        if (pc) pc.close();
        rdb.ref(`signaling/${myUid}`).remove();
        window.location.reload();
    }

    function showCallUI(name, pfp, status, verified) {
        document.getElementById('call-screen').style.display = 'flex';
        document.getElementById('target-name').innerHTML = `${name} ${verified ? '<span class="v-badge"></span>' : ''}`;
        document.getElementById('target-pfp').src = pfp || 'https://via.placeholder.com/150';
        document.getElementById('call-status').innerText = status;
    }

    function toggleMic() {
        const t = localStream.getAudioTracks()[0];
        t.enabled = !t.enabled;
        document.getElementById('mic-btn').classList.toggle('btn-off', !t.enabled);
    }

    function toggleCam() {
        isCamOn = !isCamOn;
        const t = localStream.getVideoTracks()[0];
        t.enabled = isCamOn;
        document.getElementById('cam-btn').classList.toggle('btn-off', !isCamOn);
        document.getElementById('local-video').style.display = isCamOn ? 'block' : 'none';
    }

    function toggleSpeaker() {
        document.getElementById('speaker-btn').classList.toggle('btn-off');
    }
</script>
</body>
</html>