<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Goorac | Quantum</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { 
            --bg: #000; --accent: #00d2ff; --border: rgba(255, 255, 255, 0.1); 
            --sent: #00d2ff; --received: #1a1a1a; --text: #fff; 
        }

        * { 
            box-sizing: border-box; -webkit-tap-highlight-color: transparent; 
            -webkit-user-select: none !important; user-select: none !important; 
        }
        input { -webkit-user-select: text !important; user-select: text !important; outline: none; }

        html, body { 
            height: 100%; margin: 0; background: var(--bg); color: var(--text); 
            font-family: -apple-system, system-ui, sans-serif; overflow: hidden; position: fixed; width: 100%; 
        }

        .app-container { display: flex; flex-direction: column; height: 100vh; }

        header { 
            padding: 10px 15px; background: rgba(0,0,0,0.9); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; gap: 12px; z-index: 100; backdrop-filter: blur(10px); 
        }
        .h-pfp { width: 38px; height: 38px; border-radius: 50%; border: 1.5px solid var(--accent); object-fit: cover; }
        .h-info { display: flex; flex-direction: column; }
        .h-name { font-weight: 700; font-size: 0.95rem; }
        .h-status { font-size: 0.7rem; color: var(--accent); }

        #chat-flow { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; scroll-behavior: smooth; }
        
        .msg-wrap { 
            display: flex; flex-direction: column; max-width: 82%; margin-bottom: 20px; 
            position: relative; transition: transform 0.2s cubic-bezier(0.1, 0.8, 0.2, 1); will-change: transform;
        }
        .sent { align-self: flex-end; }
        .received { align-self: flex-start; }

        .reply-box-ui { 
            background: rgba(255,255,255,0.06); padding: 5px 10px; border-radius: 10px; 
            margin-bottom: 4px; font-size: 0.75rem; border-left: 3px solid var(--accent); color: #888;
            max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .bubble { padding: 12px 16px; border-radius: 20px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; }
        .sent .bubble { background: var(--sent); color: #000; border-bottom-right-radius: 4px; font-weight: 500; }
        .received .bubble { background: var(--received); border: 1px solid var(--border); border-bottom-left-radius: 4px; }

        .reaction-badge { 
            position: absolute; bottom: -12px; background: #1a1a1a; border: 1px solid var(--border); 
            border-radius: 20px; padding: 2px 6px; font-size: 0.85rem; z-index: 10; display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5); transform: scale(1); transition: transform 0.2s;
        }
        .sent .reaction-badge { right: 10px; }
        .received .reaction-badge { left: 10px; }

        .meta { display: flex; align-items: center; gap: 5px; margin-top: 5px; font-size: 0.65rem; color: #555; }
        .sent .meta { justify-content: flex-end; }
        .seen { color: var(--accent); font-weight: 700; }

        /* OVERLAYS */
        #menu-overlay { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); 
        }
        .menu-card { background: #1a1a1a; border-radius: 24px; width: 280px; border: 1px solid var(--border); overflow: hidden; }
        .reaction-bar { display: flex; justify-content: space-around; padding: 15px; border-bottom: 1px solid var(--border); }
        .reaction-bar span { font-size: 1.8rem; cursor: pointer; transition: transform 0.1s; }
        .reaction-bar span:active { transform: scale(1.4); }
        .menu-opt { padding: 16px; text-align: center; font-weight: 600; cursor: pointer; border-bottom: 1px solid var(--border); }
        .menu-opt.danger { color: #ff4444; }

        #reply-dock { 
            display: none; background: #0a0a0a; padding: 8px 15px; border-top: 2px solid var(--accent); 
            justify-content: space-between; align-items: center; 
        }

        .input-area { background: #000; border-top: 1px solid var(--border); padding: 10px 15px 30px; display: flex; align-items: center; gap: 10px; }
        .input-box { flex: 1; background: #121212; border: 1px solid var(--border); border-radius: 25px; padding: 0 15px; }
        .msg-input { width: 100%; background: transparent; border: none; color: white; padding: 12px 0; font-size: 1rem; }
        .send-btn { background: var(--accent); color: #000; border: none; width: 42px; height: 42px; border-radius: 50%; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body oncontextmenu="return false;">

<div id="menu-overlay" onclick="closeMenu()">
    <div class="menu-card" onclick="event.stopPropagation()">
        <div class="reaction-bar">
            <span onclick="applyReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span onclick="applyReaction('üòÇ')">üòÇ</span>
            <span onclick="applyReaction('üòÆ')">üòÆ</span>
            <span onclick="applyReaction('üî•')">üî•</span>
            <span onclick="applyReaction('üëç')">üëç</span>
        </div>
        <div id="edit-btn" class="menu-opt" onclick="initEdit()">Edit Message</div>
        <div id="unsend-btn" class="menu-opt danger" onclick="unsendMsg()">Unsend</div>
        <div class="menu-opt" onclick="closeMenu()" style="border-bottom:none;">Cancel</div>
    </div>
</div>

<div class="app-container">
    <header>
        <div onclick="history.back()" style="font-size: 1.8rem; cursor: pointer; margin-right: 10px;">‚Äπ</div>
        <img id="h-pfp" src="https://via.placeholder.com/150" class="h-pfp">
        <div class="h-info">
            <div class="h-name" id="h-name">...</div>
            <div id="h-status" class="h-status">Quantum Active</div>
        </div>
    </header>

    <div id="chat-flow">
        <div id="messages-container" style="display:flex; flex-direction:column;"></div>
    </div>

    <div id="reply-dock">
        <div id="reply-text" style="font-size:0.75rem; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80%;"></div>
        <div onclick="cancelReply()" style="color:var(--accent); font-weight:bold; cursor:pointer; padding:5px;">‚úï</div>
    </div>

    <div class="input-area">
        <div class="input-box">
            <input type="text" id="m-input" class="msg-input" placeholder="Quantum message..." autocomplete="off">
        </div>
        <button class="send-btn" onclick="sendMsg()">‚û§</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
        databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const params = new URLSearchParams(window.location.search);
    const targetUsername = params.get('user');
    let myUid, targetUid, chatId, replyingTo = null, editModeId = null;
    let firstLoad = true, activeMenuId = null;

    auth.onAuthStateChanged(user => {
        if (user) { myUid = user.uid; initChat(); }
        else { window.location.href = 'login.html'; }
    });

    async function initChat() {
        if(!targetUsername) return;
        const snap = await db.collection("users").where("username", "==", targetUsername).get();
        if (snap.empty) return;
        targetUid = snap.docs[0].id;
        chatId = myUid < targetUid ? `${myUid}_${targetUid}` : `${targetUid}_${myUid}`;
        
        const targetData = snap.docs[0].data();
        document.getElementById('h-name').innerText = targetData.username;
        document.getElementById('h-pfp').src = targetData.photoURL || 'https://via.placeholder.com/150';

        db.collection("chats").doc(chatId).collection("messages").orderBy("timestamp", "asc")
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    const id = change.doc.id;
                    if (change.type === "added") renderMessage(data, id);
                    if (change.type === "modified") updateUI(id, data);
                    if (change.type === "removed") document.getElementById(id)?.remove();
                });
                if (firstLoad) { scrollToBottom(); firstLoad = false; }
            });
    }

    function renderMessage(m, id) {
        if (document.getElementById(id)) return;
        const container = document.getElementById('messages-container');
        const side = m.sender === myUid ? 'sent' : 'received';
        const date = m.timestamp ? m.timestamp.toDate() : new Date();

        const div = document.createElement('div');
        div.id = id;
        div.className = `msg-wrap ${side}`;
        
        // --- Swipe Logic ---
        let startX = 0;
        let touchTimer;
        div.ontouchstart = (e) => { 
            startX = e.touches[0].clientX; 
            touchTimer = setTimeout(() => openMenu(id, m.sender, m.text), 600);
        };
        div.ontouchmove = (e) => {
            let diff = e.touches[0].clientX - startX;
            if (diff > 0 && diff < 80) {
                clearTimeout(touchTimer);
                div.style.transform = `translateX(${diff}px)`;
            }
        };
        div.ontouchend = (e) => {
            clearTimeout(touchTimer);
            if (e.changedTouches[0].clientX - startX > 55) triggerReply(m.text);
            div.style.transform = `translateX(0)`;
        };

        // --- FIXED UNDO REACTION LOGIC ---
        div.ondblclick = (e) => {
            e.preventDefault();
            const badge = document.getElementById(`react-${id}`);
            // Check current visual state instead of stale 'm' variable
            const currentEmo = badge ? badge.innerText : "";
            const newEmo = (currentEmo === "‚ù§Ô∏è") ? "" : "‚ù§Ô∏è";
            applyReactionToId(id, newEmo);
        };

        div.innerHTML = `
            ${m.replyTo ? `<div class="reply-box-ui">‚§¥ ${m.replyTo}</div>` : ''}
            <div class="bubble">
                <span id="text-${id}">${m.text}</span>
                <div id="react-${id}" class="reaction-badge"></div>
            </div>
            <div class="meta">
                ${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                ${side === 'sent' ? `<span id="seen-${id}" class="seen">${m.seen ? 'Seen' : '‚úì'}</span>` : ''}
            </div>
        `;

        container.appendChild(div);
        updateUI(id, m);
    }

    function updateUI(id, data) {
        const textSpan = document.getElementById(`text-${id}`);
        if (textSpan) textSpan.innerHTML = data.text + (data.edited ? ' <small style="opacity:0.4;font-size:0.6rem">(edited)</small>' : '');
        
        const badge = document.getElementById(`react-${id}`);
        if (badge) {
            badge.innerText = data.reaction || "";
            badge.style.display = data.reaction ? "block" : "none";
        }

        const seenSpan = document.getElementById(`seen-${id}`);
        if (seenSpan && data.seen) seenSpan.innerText = "Seen";
    }

    function openMenu(id, sender, text) {
        activeMenuId = id;
        const isMine = sender === myUid;
        document.getElementById('edit-btn').style.display = isMine ? 'block' : 'none';
        document.getElementById('unsend-btn').style.display = isMine ? 'block' : 'none';
        document.getElementById('menu-overlay').style.display = 'flex';
    }

    function closeMenu() { document.getElementById('menu-overlay').style.display = 'none'; }

    function applyReaction(emoji) {
        if (activeMenuId) {
            const badge = document.getElementById(`react-${activeMenuId}`);
            const currentEmo = badge ? badge.innerText : "";
            // Toggle if same emoji clicked in menu
            const newEmo = (currentEmo === emoji) ? "" : emoji;
            applyReactionToId(activeMenuId, newEmo);
        }
        closeMenu();
    }

    function applyReactionToId(id, emoji) {
        db.collection("chats").doc(chatId).collection("messages").doc(id).update({ reaction: emoji })
        .catch(err => console.error("Reaction Error:", err));
    }

    function triggerReply(text) {
        replyingTo = text;
        document.getElementById('reply-dock').style.display = 'flex';
        document.getElementById('reply-text').innerText = `Replying to: ${text}`;
        document.getElementById('m-input').focus();
    }

    function cancelReply() { replyingTo = null; document.getElementById('reply-dock').style.display = 'none'; }

    function initEdit() {
        const span = document.getElementById('text-'+activeMenuId);
        if(!span) return;
        const currentText = span.innerText.replace('(edited)', '').trim();
        document.getElementById('m-input').value = currentText;
        editModeId = activeMenuId;
        closeMenu();
        document.getElementById('m-input').focus();
    }

    async function unsendMsg() {
        if(!activeMenuId) return;
        db.collection("chats").doc(chatId).collection("messages").doc(activeMenuId).delete()
        .then(() => closeMenu())
        .catch(err => alert("Could not unsend: " + err.message));
    }

    async function sendMsg() {
        const input = document.getElementById('m-input');
        const text = input.value.trim();
        if (!text) return;

        try {
            if (editModeId) {
                await db.collection("chats").doc(chatId).collection("messages").doc(editModeId).update({ 
                    text: text, 
                    edited: true 
                });
                editModeId = null;
            } else {
                const rText = replyingTo;
                cancelReply();
                await db.collection("chats").doc(chatId).collection("messages").add({
                    text, sender: myUid, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    replyTo: rText, seen: false, reaction: ""
                });
            }
            input.value = "";
            scrollToBottom();
        } catch (e) {
            alert("Send failed: " + e.message);
        }
    }

    function scrollToBottom() { 
        const f = document.getElementById('chat-flow'); 
        setTimeout(() => { f.scrollTop = f.scrollHeight; }, 100);
    }
</script>
</body>
</html>