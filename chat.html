<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Goorac | Quantum</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { 
            --bg: #000; --accent: #00d2ff; --border: rgba(255, 255, 255, 0.1); 
            --sent: #00d2ff; --received: #1a1a1a; --text: #fff; 
        }

        * { 
            box-sizing: border-box; -webkit-tap-highlight-color: transparent; 
            margin: 0; padding: 0; -webkit-touch-callout: none; 
        }
        
        body { 
            -webkit-user-select: none; user-select: none; 
            height: 100%; width: 100%; background: var(--bg); color: var(--text); 
            font-family: -apple-system, system-ui, sans-serif; 
            overflow: hidden; position: fixed; 
        }

        input { 
            -webkit-user-select: text !important; 
            user-select: text !important; 
            outline: none; 
            font-size: 16px !important; 
        }

        .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; }

        header { 
            padding: 10px 15px; background: rgba(0,0,0,0.9); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; gap: 12px; z-index: 100; backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        .h-pfp { width: 38px; height: 38px; border-radius: 50%; border: 1.5px solid var(--accent); object-fit: cover; }
        .h-info { display: flex; flex-direction: column; }
        .h-name { font-weight: 700; font-size: 0.95rem; }

        #chat-flow { 
            flex: 1; overflow-y: auto; padding: 15px; 
            display: flex; flex-direction: column-reverse; 
            -webkit-overflow-scrolling: touch; 
        }
        
        #messages-container { display: flex; flex-direction: column; }

        /* Bottom Typing Indicator Styling */
        #typing-indicator-bottom {
            padding: 8px 14px;
            font-size: 0.75rem;
            color: var(--accent);
            font-weight: 600;
            display: none;
            align-self: flex-start;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            animation: typingPulse 1.5s infinite ease-in-out;
        }

        @keyframes typingPulse {
            0% { opacity: 0.5; transform: translateY(0); }
            50% { opacity: 1; transform: translateY(-2px); }
            100% { opacity: 0.5; transform: translateY(0); }
        }

        #scroll-trigger {
            text-align: center; padding: 20px; color: var(--accent); 
            font-size: 0.8rem; font-weight: bold; opacity: 0.6;
        }

        .msg-wrap { 
            display: flex; flex-direction: column; max-width: 82%; margin-bottom: 22px; 
            position: relative; will-change: transform;
        }
        .sent { align-self: flex-end; }
        .received { align-self: flex-start; }

        .bubble { padding: 12px 16px; border-radius: 20px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .sent .bubble { background: var(--sent); color: #000; border-bottom-right-radius: 4px; font-weight: 500; }
        .received .bubble { background: var(--received); border: 1px solid var(--border); border-bottom-left-radius: 4px; }

        .reaction-badge { 
            position: absolute; bottom: -12px; background: #1a1a1a; border: 1px solid var(--border); 
            border-radius: 20px; padding: 2px 6px; font-size: 0.85rem; z-index: 10; display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .sent .reaction-badge { right: 10px; }
        .received .reaction-badge { left: 10px; }

        .meta { display: flex; align-items: center; gap: 5px; margin-top: 5px; font-size: 0.65rem; color: #555; }
        .sent .meta { justify-content: flex-end; }
        .seen { color: var(--accent); font-weight: 700; }

        .reply-box-ui { 
            background: rgba(255,255,255,0.06); padding: 5px 10px; border-radius: 10px; 
            margin-bottom: 4px; font-size: 0.75rem; border-left: 3px solid var(--accent); color: #888;
            max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .input-area { background: #000; border-top: 1px solid var(--border); padding: 10px 15px 25px; display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .input-box { flex: 1; background: #121212; border: 1px solid var(--border); border-radius: 25px; padding: 0 15px; }
        .msg-input { width: 100%; background: transparent; border: none; color: white; padding: 12px 0; font-size: 16px; }
        .send-btn { background: var(--accent); color: #000; border: none; width: 42px; height: 42px; border-radius: 50%; font-weight: 800; display: flex; align-items: center; justify-content: center; }

        #menu-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .menu-card { background: #1a1a1a; border-radius: 24px; width: 280px; border: 1px solid var(--border); overflow: hidden; }
        .reaction-bar { display: flex; justify-content: space-around; padding: 15px; border-bottom: 1px solid var(--border); }
        .reaction-bar span { font-size: 1.8rem; cursor: pointer; }
        .menu-opt { padding: 16px; text-align: center; font-weight: 600; border-bottom: 1px solid var(--border); }
        
        #reply-dock { display: none; background: #0a0a0a; padding: 8px 15px; border-top: 2px solid var(--accent); justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div id="menu-overlay" onclick="closeMenu()">
    <div class="menu-card" onclick="event.stopPropagation()">
        <div class="reaction-bar">
            <span onclick="applyReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span onclick="applyReaction('üòÇ')">üòÇ</span>
            <span onclick="applyReaction('üòÆ')">üòÆ</span>
            <span onclick="applyReaction('üî•')">üî•</span>
            <span onclick="applyReaction('üëç')">üëç</span>
        </div>
        <div class="menu-opt" onclick="initReplyFromActive()">Reply</div>
        <div id="edit-btn" class="menu-opt" onclick="initEdit()">Edit Message</div>
        <div id="unsend-btn" class="menu-opt" style="color:#ff4444" onclick="unsendMsg()">Unsend</div>
        <div class="menu-opt" onclick="closeMenu()" style="border-bottom:none;">Cancel</div>
    </div>
</div>

<div class="app-container" id="main-app">
    <header>
        <div onclick="history.back()" style="font-size: 1.8rem; padding-right:10px; cursor:pointer">‚Äπ</div>
        <img id="h-pfp" src="" class="h-pfp">
        <div class="h-info">
            <div class="h-name" id="h-name">...</div>
        </div>
    </header>

    <div id="chat-flow">
        <div id="typing-indicator-bottom">typing...</div>
        <div id="messages-container"></div>
        <div id="scroll-trigger">‚óè ‚óè ‚óè</div>
    </div>

    <div id="reply-dock">
        <div id="reply-text" style="font-size:0.75rem; color:#888; overflow:hidden; text-overflow:ellipsis;"></div>
        <div onclick="cancelReply()" style="color:var(--accent); font-weight:bold; padding:5px;">‚úï</div>
    </div>

    <div class="input-area">
        <div class="input-box">
            <input type="text" id="m-input" class="msg-input" placeholder="Quantum message..." autocomplete="off">
        </div>
        <button class="send-btn" onclick="sendMsg()">‚û§</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
        databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const rdb = firebase.database();
    const auth = firebase.auth();

    const params = new URLSearchParams(window.location.search);
    const targetUsername = params.get('user');
    let myUid, targetUid, chatId, replyingTo = null, editModeId = null;
    let activeMenuId = null, msgLimit = 15, unsubscribe = null, isLoadingMore = false;

    const mInput = document.getElementById('m-input');
    const chatFlow = document.getElementById('chat-flow');
    const container = document.getElementById('messages-container');
    const bottomTyping = document.getElementById('typing-indicator-bottom');

    window.oncontextmenu = (e) => { e.preventDefault(); return false; };

    function vibrate(ms = 50) { if (navigator.vibrate) navigator.vibrate(ms); }

    auth.onAuthStateChanged(user => {
        if (user) { myUid = user.uid; initChat(); }
        else { window.location.href = 'login.html'; }
    });

    async function initChat() {
        if(!targetUsername) return;
        const snap = await db.collection("users").where("username", "==", targetUsername).get();
        if (snap.empty) return;
        targetUid = snap.docs[0].id;
        chatId = myUid < targetUid ? `${myUid}_${targetUid}` : `${targetUid}_${myUid}`;
        
        const targetData = snap.docs[0].data();
        document.getElementById('h-name').innerText = targetData.username;
        document.getElementById('h-pfp').src = targetData.photoURL || 'https://via.placeholder.com/150';

        // Bottom Typing Listener
        rdb.ref(`typing/${chatId}/${targetUid}`).on('value', (s) => {
            const isTyping = s.val();
            bottomTyping.style.display = isTyping ? 'block' : 'none';
            if(isTyping && chatFlow.scrollTop < 100) {
                chatFlow.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        startListener();
        setupObserver();
    }

    function setupObserver() {
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !isLoadingMore && container.children.length >= msgLimit) {
                isLoadingMore = true;
                msgLimit += 10;
                startListener();
            }
        }, { root: chatFlow, threshold: 0.1 });
        observer.observe(document.getElementById('scroll-trigger'));
    }

    function startListener() {
        if (unsubscribe) unsubscribe();
        
        unsubscribe = db.collection("chats").doc(chatId).collection("messages")
            .orderBy("timestamp", "desc")
            .limit(msgLimit)
            .onSnapshot(snapshot => {
                const previousHeight = chatFlow.scrollHeight;
                const previousScroll = chatFlow.scrollTop;

                container.innerHTML = '';
                const docs = [];
                snapshot.forEach(doc => docs.push({id: doc.id, data: doc.data()}));
                
                docs.reverse().forEach(item => {
                    renderMessage(item.data, item.id);
                    if(item.data.sender !== myUid && !item.data.seen) {
                        db.collection("chats").doc(chatId).collection("messages").doc(item.id).update({ seen: true });
                    }
                });

                if (isLoadingMore) {
                    setTimeout(() => {
                        chatFlow.scrollTop = previousScroll + (chatFlow.scrollHeight - previousHeight);
                        isLoadingMore = false;
                    }, 0);
                }
            });
    }

    function renderMessage(m, id) {
        const side = m.sender === myUid ? 'sent' : 'received';
        const date = m.timestamp ? m.timestamp.toDate() : new Date();

        const div = document.createElement('div');
        div.id = id;
        div.className = `msg-wrap ${side}`;
        
        div.addEventListener('dblclick', (e) => {
            e.preventDefault();
            vibrate(40);
            applyReactionToId(id, m.reaction === '‚ù§Ô∏è' ? '' : '‚ù§Ô∏è');
        });

        let startX = 0, currentX = 0, menuTimer = null, isMoving = false, swipeTriggered = false;

        div.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            isMoving = false; swipeTriggered = false;
            menuTimer = setTimeout(() => {
                if (!isMoving) { vibrate(70); openMenu(id, m.sender, m.text); }
            }, 600);
        }, {passive: true});

        div.addEventListener('touchmove', (e) => {
            currentX = e.touches[0].clientX;
            let diff = currentX - startX;
            if (Math.abs(diff) > 10) isMoving = true;
            if (diff > 0 && diff < 100) {
                div.querySelector('.bubble').style.transform = `translateX(${diff}px)`;
                div.querySelector('.bubble').style.transition = "none";
                if (diff > 65 && !swipeTriggered) { vibrate(30); swipeTriggered = true; }
            }
        }, {passive: true});

        div.addEventListener('touchend', () => {
            clearTimeout(menuTimer);
            let diff = currentX - startX;
            const bubble = div.querySelector('.bubble');
            bubble.style.transition = "transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
            bubble.style.transform = `translateX(0px)`;
            if (diff > 65) triggerReply(m.text);
            startX = 0; currentX = 0;
        });

        div.innerHTML = `
            ${m.replyTo ? `<div class="reply-box-ui">‚§¥ ${m.replyTo}</div>` : ''}
            <div class="bubble">
                <span id="text-${id}">${m.text} ${m.edited ? '<small style="opacity:0.3;font-size:0.6rem">(edited)</small>' : ''}</span>
                <div id="react-${id}" class="reaction-badge" style="${m.reaction ? 'display:block' : ''}">${m.reaction || ''}</div>
            </div>
            <div class="meta">
                ${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                ${side === 'sent' ? `<span class="seen">${m.seen ? 'Seen' : '‚úì'}</span>` : ''}
            </div>
        `;

        container.appendChild(div);
    }

    function triggerReply(text) {
        replyingTo = text;
        document.getElementById('reply-text').innerText = replyingTo;
        document.getElementById('reply-dock').style.display = 'flex';
        mInput.focus();
    }

    async function sendMsg() {
        const text = mInput.value.trim();
        if (!text) return;
        rdb.ref(`typing/${chatId}/${myUid}`).set(false);
        if (editModeId) {
            await db.collection("chats").doc(chatId).collection("messages").doc(editModeId).update({ text, edited: true });
            editModeId = null;
        } else {
            const rText = replyingTo; cancelReply();
            await db.collection("chats").doc(chatId).collection("messages").add({
                text, sender: myUid, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                replyTo: rText, seen: false, reaction: ""
            });
        }
        mInput.value = "";
    }

    function openMenu(id, sender, text) {
        activeMenuId = id;
        const isMine = sender === myUid;
        document.getElementById('edit-btn').style.display = isMine ? 'block' : 'none';
        document.getElementById('unsend-btn').style.display = isMine ? 'block' : 'none';
        document.getElementById('menu-overlay').style.display = 'flex';
    }

    async function applyReaction(emoji) {
        if (!activeMenuId) return;
        const msgRef = db.collection("chats").doc(chatId).collection("messages").doc(activeMenuId);
        const doc = await msgRef.get();
        const currentReaction = doc.data().reaction;
        await msgRef.update({ reaction: currentReaction === emoji ? "" : emoji });
        closeMenu();
    }

    async function applyReactionToId(id, emoji) {
        await db.collection("chats").doc(chatId).collection("messages").doc(id).update({ reaction: emoji });
    }

    function initReplyFromActive() {
        triggerReply(document.getElementById('text-'+activeMenuId).innerText.split('(edited)')[0].trim());
        closeMenu();
    }

    function closeMenu() { document.getElementById('menu-overlay').style.display = 'none'; }
    function cancelReply() { replyingTo = null; document.getElementById('reply-dock').style.display = 'none'; }
    
    function initEdit() {
        mInput.value = document.getElementById('text-'+activeMenuId).innerText.split('(edited)')[0].trim();
        editModeId = activeMenuId; closeMenu(); mInput.focus();
    }

    async function unsendMsg() { 
        if(activeMenuId) db.collection("chats").doc(chatId).collection("messages").doc(activeMenuId).delete(); 
        closeMenu(); 
    }

    mInput.oninput = () => rdb.ref(`typing/${chatId}/${myUid}`).set(mInput.value.trim().length > 0);
</script>
</body>
</html>