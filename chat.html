<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Goorac | Quantum</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { 
            --bg: #000; --accent: #00d2ff; --border: rgba(255, 255, 255, 0.1); 
            --sent: #00d2ff; --received: #1a1a1a; --text: #fff; 
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            margin: 0; padding: 0;
            /* Disable default long-press behaviors */
            -webkit-touch-callout: none; 
        }
        
        body { 
            -webkit-user-select: none; user-select: none; 
            height: 100%; width: 100%; background: var(--bg); color: var(--text); 
            font-family: -apple-system, system-ui, sans-serif; 
            overflow: hidden; position: fixed; 
        }

        input { -webkit-user-select: text !important; user-select: text !important; outline: none; }

        .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; }

        header { 
            padding: 10px 15px; background: rgba(0,0,0,0.9); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; gap: 12px; z-index: 100; backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        .h-pfp { width: 38px; height: 38px; border-radius: 50%; border: 1.5px solid var(--accent); object-fit: cover; }
        .h-info { display: flex; flex-direction: column; }
        .h-name { font-weight: 700; font-size: 0.95rem; }
        .h-status { font-size: 0.7rem; color: var(--accent); height: 14px; font-weight: bold; transition: opacity 0.2s; }

        #chat-flow { 
            flex: 1; overflow-y: auto; padding: 15px; 
            display: flex; flex-direction: column; 
            -webkit-overflow-scrolling: touch;
        }
        
        .msg-wrap { 
            display: flex; flex-direction: column; max-width: 82%; margin-bottom: 22px; 
            position: relative; will-change: transform;
        }
        .sent { align-self: flex-end; }
        .received { align-self: flex-start; }

        .bubble { padding: 12px 16px; border-radius: 20px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; }
        .sent .bubble { background: var(--sent); color: #000; border-bottom-right-radius: 4px; font-weight: 500; }
        .received .bubble { background: var(--received); border: 1px solid var(--border); border-bottom-left-radius: 4px; }

        .reaction-badge { 
            position: absolute; bottom: -12px; background: #1a1a1a; border: 1px solid var(--border); 
            border-radius: 20px; padding: 2px 6px; font-size: 0.85rem; z-index: 10; display: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .sent .reaction-badge { right: 10px; }
        .received .reaction-badge { left: 10px; }

        .meta { display: flex; align-items: center; gap: 5px; margin-top: 5px; font-size: 0.65rem; color: #555; }
        .sent .meta { justify-content: flex-end; }
        .seen { color: var(--accent); font-weight: 700; }

        .reply-box-ui { 
            background: rgba(255,255,255,0.06); padding: 5px 10px; border-radius: 10px; 
            margin-bottom: 4px; font-size: 0.75rem; border-left: 3px solid var(--accent); color: #888;
            max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .input-area { 
            background: #000; border-top: 1px solid var(--border); 
            padding: 10px 15px 25px; display: flex; align-items: center; gap: 10px;
            flex-shrink: 0;
        }
        .input-box { flex: 1; background: #121212; border: 1px solid var(--border); border-radius: 25px; padding: 0 15px; }
        .msg-input { width: 100%; background: transparent; border: none; color: white; padding: 12px 0; font-size: 16px; }
        .send-btn { background: var(--accent); color: #000; border: none; width: 42px; height: 42px; border-radius: 50%; font-weight: 800; display: flex; align-items: center; justify-content: center; }

        #menu-overlay { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); 
        }
        .menu-card { background: #1a1a1a; border-radius: 24px; width: 280px; border: 1px solid var(--border); overflow: hidden; }
        .reaction-bar { display: flex; justify-content: space-around; padding: 15px; border-bottom: 1px solid var(--border); }
        .reaction-bar span { font-size: 1.8rem; cursor: pointer; }
        .menu-opt { padding: 16px; text-align: center; font-weight: 600; border-bottom: 1px solid var(--border); }
        
        #reply-dock { 
            display: none; background: #0a0a0a; padding: 8px 15px; border-top: 2px solid var(--accent); 
            justify-content: space-between; align-items: center; 
        }
    </style>
</head>
<body>

<div id="menu-overlay" onclick="closeMenu()">
    <div class="menu-card" onclick="event.stopPropagation()">
        <div class="reaction-bar">
            <span onclick="applyReaction('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span onclick="applyReaction('üòÇ')">üòÇ</span>
            <span onclick="applyReaction('üòÆ')">üòÆ</span>
            <span onclick="applyReaction('üî•')">üî•</span>
            <span onclick="applyReaction('üëç')">üëç</span>
        </div>
        <div class="menu-opt" onclick="initReply()">Reply</div>
        <div id="edit-btn" class="menu-opt" onclick="initEdit()">Edit Message</div>
        <div id="unsend-btn" class="menu-opt" style="color:#ff4444" onclick="unsendMsg()">Unsend</div>
        <div class="menu-opt" onclick="closeMenu()" style="border-bottom:none;">Cancel</div>
    </div>
</div>

<div class="app-container">
    <header>
        <div onclick="history.back()" style="font-size: 1.8rem; padding-right:10px;">‚Äπ</div>
        <img id="h-pfp" src="" class="h-pfp">
        <div class="h-info" id="profile-link">
            <div class="h-name" id="h-name">...</div>
            <div id="h-status" class="h-status"></div>
        </div>
    </header>

    <div id="chat-flow">
        <div id="messages-container" style="display:flex; flex-direction:column;"></div>
    </div>

    <div id="reply-dock">
        <div id="reply-text" style="font-size:0.75rem; color:#888; overflow:hidden; text-overflow:ellipsis;"></div>
        <div onclick="cancelReply()" style="color:var(--accent); font-weight:bold; padding:5px;">‚úï</div>
    </div>

    <div class="input-area">
        <div class="input-box">
            <input type="text" id="m-input" class="msg-input" placeholder="Quantum message..." autocomplete="off">
        </div>
        <button class="send-btn" onclick="sendMsg()">‚û§</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51",
        databaseURL: "https://goorac-c3b59-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const rdb = firebase.database();
    const auth = firebase.auth();

    const params = new URLSearchParams(window.location.search);
    const targetUsername = params.get('user');
    let myUid, targetUid, chatId, replyingTo = null, editModeId = null;
    let firstLoad = true, activeMenuId = null, isCurrentlyTyping = false;

    // --- GLOBAL BROWSER POPUP DISABLE ---
    window.oncontextmenu = function(e) { e.preventDefault(); e.stopPropagation(); return false; };

    const mInput = document.getElementById('m-input');
    function setDocHeight() { document.body.style.height = `${window.innerHeight}px`; }
    window.addEventListener('resize', () => { setDocHeight(); scrollToBottom(); });
    setDocHeight();

    mInput.addEventListener('focus', () => { setTimeout(scrollToBottom, 300); });

    auth.onAuthStateChanged(user => {
        if (user) { myUid = user.uid; initChat(); }
        else { window.location.href = 'login.html'; }
    });

    async function initChat() {
        if(!targetUsername) return;
        const snap = await db.collection("users").where("username", "==", targetUsername).get();
        if (snap.empty) return;
        targetUid = snap.docs[0].id;
        chatId = myUid < targetUid ? `${myUid}_${targetUid}` : `${targetUid}_${myUid}`;
        
        const targetData = snap.docs[0].data();
        document.getElementById('h-name').innerText = targetData.username;
        document.getElementById('h-pfp').src = targetData.photoURL || 'https://via.placeholder.com/150';

        rdb.ref(`typing/${chatId}/${targetUid}`).on('value', (s) => {
            const statusEl = document.getElementById('h-status');
            statusEl.innerText = s.val() ? 'typing...' : '';
            statusEl.style.opacity = s.val() ? '1' : '0';
        });

        db.collection("chats").doc(chatId).collection("messages").orderBy("timestamp", "asc")
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    const id = change.doc.id;
                    if (change.type === "added") renderMessage(data, id);
                    if (change.type === "modified") updateUI(id, data);
                    if (change.type === "removed") document.getElementById(id)?.remove();
                });
                if (firstLoad) { scrollToBottom(); firstLoad = false; }
            });
    }

    mInput.oninput = (e) => {
        const hasText = e.target.value.length > 0;
        if (hasText !== isCurrentlyTyping) {
            isCurrentlyTyping = hasText;
            rdb.ref(`typing/${chatId}/${myUid}`).set(hasText);
        }
        clearTimeout(window.typingTimer);
        window.typingTimer = setTimeout(() => {
            isCurrentlyTyping = false;
            rdb.ref(`typing/${chatId}/${myUid}`).set(false);
        }, 2500);
    };

    function renderMessage(m, id) {
        if (document.getElementById(id)) return;
        const container = document.getElementById('messages-container');
        const side = m.sender === myUid ? 'sent' : 'received';
        const date = m.timestamp ? m.timestamp.toDate() : new Date();

        const div = document.createElement('div');
        div.id = id;
        div.className = `msg-wrap ${side}`;
        
        // Custom Long Press
        let timer;
        div.ontouchstart = () => { timer = setTimeout(() => openMenu(id, m.sender, m.text), 600); };
        div.ontouchend = () => clearTimeout(timer);
        div.ontouchmove = () => clearTimeout(timer);

        // Double Tap to Like
        div.ondblclick = (e) => {
            e.preventDefault();
            const current = document.getElementById(`react-${id}`).innerText;
            applyReactionToId(id, current === "‚ù§Ô∏è" ? "" : "‚ù§Ô∏è");
        };

        div.innerHTML = `
            ${m.replyTo ? `<div class="reply-box-ui">‚§¥ ${m.replyTo}</div>` : ''}
            <div class="bubble">
                <span id="text-${id}">${m.text}</span>
                <div id="react-${id}" class="reaction-badge"></div>
            </div>
            <div class="meta">
                ${date.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                ${side === 'sent' ? `<span id="seen-${id}" class="seen">${m.seen ? 'Seen' : '‚úì'}</span>` : ''}
            </div>
        `;

        container.appendChild(div);
        updateUI(id, m);
        if(!firstLoad) scrollToBottom();
    }

    function updateUI(id, data) {
        const textSpan = document.getElementById(`text-${id}`);
        if (textSpan) textSpan.innerHTML = data.text + (data.edited ? ' <small style="opacity:0.4;font-size:0.6rem">(edited)</small>' : '');
        
        const badge = document.getElementById(`react-${id}`);
        if (badge) {
            badge.innerText = data.reaction || "";
            badge.style.display = data.reaction ? "block" : "none";
        }

        const seenSpan = document.getElementById(`seen-${id}`);
        if (seenSpan && data.seen) seenSpan.innerText = "Seen";

        if(data.sender !== myUid && !data.seen) {
            db.collection("chats").doc(chatId).collection("messages").doc(id).update({ seen: true });
        }
    }

    async function sendMsg() {
        const text = mInput.value.trim();
        if (!text) return;

        if (editModeId) {
            await db.collection("chats").doc(chatId).collection("messages").doc(editModeId).update({ text, edited: true });
            editModeId = null;
        } else {
            const rText = replyingTo;
            cancelReply();
            await db.collection("chats").doc(chatId).collection("messages").add({
                text, sender: myUid, timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                replyTo: rText, seen: false, reaction: ""
            });
        }
        mInput.value = "";
        isCurrentlyTyping = false;
        rdb.ref(`typing/${chatId}/${myUid}`).set(false);
        scrollToBottom();
    }

    function openMenu(id, sender, text) {
        activeMenuId = id;
        const isMine = sender === myUid;
        document.getElementById('edit-btn').style.display = isMine ? 'block' : 'none';
        document.getElementById('unsend-btn').style.display = isMine ? 'block' : 'none';
        document.getElementById('menu-overlay').style.display = 'flex';
    }

    function applyReaction(emoji) {
        if (activeMenuId) {
            const current = document.getElementById(`react-${activeMenuId}`).innerText;
            applyReactionToId(activeMenuId, current === emoji ? "" : emoji);
        }
        closeMenu();
    }

    function applyReactionToId(id, emoji) {
        db.collection("chats").doc(chatId).collection("messages").doc(id).update({ reaction: emoji });
    }

    function initReply() {
        const span = document.getElementById('text-'+activeMenuId);
        replyingTo = span.innerText;
        document.getElementById('reply-text').innerText = replyingTo;
        document.getElementById('reply-dock').style.display = 'flex';
        closeMenu();
        mInput.focus();
    }

    function initEdit() {
        const span = document.getElementById('text-'+activeMenuId);
        mInput.value = span.innerText.replace('(edited)', '').trim();
        editModeId = activeMenuId;
        closeMenu();
        mInput.focus();
    }

    async function unsendMsg() {
        if(activeMenuId) db.collection("chats").doc(chatId).collection("messages").doc(activeMenuId).delete();
        closeMenu();
    }

    function closeMenu() { document.getElementById('menu-overlay').style.display = 'none'; }
    function cancelReply() { replyingTo = null; document.getElementById('reply-dock').style.display = 'none'; }
    function scrollToBottom() { const f = document.getElementById('chat-flow'); f.scrollTop = f.scrollHeight; }
</script>
</body>
</html>