<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Goorac Profile</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --bg: #000;
            --surface: #0a0a0a;
            --accent: #00d2ff;
            --text: #ffffff;
            --dim: #666;
            --border: rgba(255, 255, 255, 0.08);
            --danger: #ff3b30;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; padding-bottom: 100px; }

        #loader { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .spin { width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: s 0.6s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }

        .app { max-width: 450px; margin: 0 auto; padding: 20px; opacity: 0; transition: 0.5s; }
        .app.show { opacity: 1; }

        header { height: 50px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .back { font-size: 30px; cursor: pointer; color: var(--accent); }

        .profile-hero { text-align: center; }
        .pfp-box { width: 110px; height: 110px; border-radius: 35px; margin: 0 auto; position: relative; padding: 3px; background: linear-gradient(var(--accent), transparent); }
        .pfp-img { width: 100%; height: 100%; border-radius: 32px; object-fit: cover; background: #111; border: 3px solid #000; }
        
        .name-row { display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 1.6rem; font-weight: 800; margin-top: 15px; }
        .v-tick { width: 20px; height: 20px; }
        .handle { color: var(--accent); font-size: 0.9rem; font-weight: 600; }
        
        .g-num { display: inline-block; background: #111; padding: 5px 15px; border-radius: 20px; color: var(--dim); font-size: 0.75rem; margin-top: 10px; border: 1px solid var(--border); }

        .bio { margin: 20px 0; color: #bbb; font-size: 0.95rem; line-height: 1.5; }

        .stats { display: flex; gap: 10px; margin-bottom: 25px; }
        .stat-card { flex: 1; background: var(--surface); border: 1px solid var(--border); padding: 15px; border-radius: 20px; text-align: center; }
        .s-val { display: block; font-size: 1.2rem; font-weight: 800; }
        .s-lbl { font-size: 0.65rem; color: var(--dim); text-transform: uppercase; }

        .actions { display: flex; gap: 10px; }
        .btn { flex: 1; height: 52px; border-radius: 16px; border: none; font-weight: 800; cursor: pointer; transition: 0.2s; }
        .btn-msg { background: #fff; color: #000; }
        .btn-f { background: var(--accent); color: #000; }
        .btn-following { background: #1a1a1a; color: #666; border: 1px solid var(--border); }
        .btn:active { transform: scale(0.96); }
    </style>
</head>
<body>

<div id="loader"><div class="spin"></div></div>

<div class="app" id="main">
    <header>
        <span class="back" onclick="history.back()">â€¹</span>
        <span style="font-weight: 800; font-size: 0.75rem; letter-spacing: 2px;">USER DOSSIER</span>
        <div style="width:30px"></div>
    </header>

    <div class="profile-hero">
        <div class="pfp-box">
            <img id="pfp" src="" class="pfp-img">
        </div>

        <div class="name-row">
            <span id="d-name">...</span>
            <img id="res-v" src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg" class="v-tick" style="display:none;">
        </div>
        <div class="handle" id="d-handle">@...</div>
        <div class="g-num">ID: <span id="d-gn">----------</span></div>

        <div class="bio" id="d-bio">...</div>

        <div class="stats">
            <div class="stat-card">
                <span class="s-val" id="c-followers">0</span>
                <span class="s-lbl">Followers</span>
            </div>
            <div class="stat-card">
                <span class="s-val" id="c-following">0</span>
                <span class="s-lbl">Following</span>
            </div>
        </div>

        <div class="actions">
            <button class="btn btn-msg" id="msg-btn">Message</button>
            <button class="btn btn-f" id="follow-action-btn">Follow</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCFzAEHC5KLiO2DEkVtoTlFn9zeCQrwImE",
        authDomain: "goorac-c3b59.firebaseapp.com",
        projectId: "goorac-c3b59",
        storageBucket: "goorac-c3b59.firebasestorage.app",
        messagingSenderId: "746746595332",
        appId: "1:746746595332:web:d3f8527d27fe8ca2530d51"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const params = new URLSearchParams(window.location.search);
    const targetUsername = params.get('user');
    let currentUserUID = "";
    let targetUserUID = "";

    auth.onAuthStateChanged(user => {
        if (user) { 
            currentUserUID = user.uid; 
            loadProfileData(); 
        } else { 
            window.location.href = 'login.html'; 
        }
    });

    async function loadProfileData() {
        if(!targetUsername) return;

        // Use onSnapshot for real-time updates to counts and bio
        db.collection("users").where("username", "==", targetUsername).onSnapshot(async (snap) => {
            if (snap.empty) return;
            const doc = snap.docs[0];
            const userData = doc.data();
            targetUserUID = doc.id;

            // Update UI fields
            document.getElementById('pfp').src = userData.photoURL || 'https://via.placeholder.com/150';
            document.getElementById('d-name').innerText = userData.name || userData.username;
            document.getElementById('d-handle').innerText = `@${userData.username}`;
            document.getElementById('d-gn').innerText = userData.gooracNumber;
            document.getElementById('d-bio').innerText = userData.bio || "No bio available.";
            document.getElementById('c-followers').innerText = userData.followerCount || 0;
            document.getElementById('c-following').innerText = userData.followingCount || 0;
            document.getElementById('res-v').style.display = userData.verified ? 'inline' : 'none';

            document.getElementById('msg-btn').onclick = () => window.location.href = `chat.html?user=${userData.username}`;

            // Check following status for the button
            await updateFollowButton();

            document.getElementById('loader').style.display = 'none';
            document.getElementById('main').classList.add('show');
        });
    }

    async function updateFollowButton() {
        if (currentUserUID === targetUserUID) {
            document.getElementById('follow-action-btn').style.display = "none";
            return;
        }

        const myDoc = await db.collection("users").doc(currentUserUID).get();
        const myFollowingList = myDoc.data().following || [];
        const btn = document.getElementById('follow-action-btn');

        if (myFollowingList.includes(targetUserUID)) {
            btn.innerText = "Following";
            btn.className = "btn btn-following";
        } else {
            btn.innerText = "Follow";
            btn.className = "btn btn-f";
        }
    }

    document.getElementById('follow-action-btn').onclick = async () => {
        const btn = document.getElementById('follow-action-btn');
        const isCurrentlyFollowing = btn.innerText === "Following";

        if (!isCurrentlyFollowing) {
            // FOLLOW LOGIC
            await db.collection("users").doc(currentUserUID).update({
                following: firebase.firestore.FieldValue.arrayUnion(targetUserUID),
                followingCount: firebase.firestore.FieldValue.increment(1)
            });
            await db.collection("users").doc(targetUserUID).update({
                followers: firebase.firestore.FieldValue.arrayUnion(currentUserUID),
                followerCount: firebase.firestore.FieldValue.increment(1)
            });
        } else {
            // UNFOLLOW LOGIC
            await db.collection("users").doc(currentUserUID).update({
                following: firebase.firestore.FieldValue.arrayRemove(targetUserUID),
                followingCount: firebase.firestore.FieldValue.increment(-1)
            });
            await db.collection("users").doc(targetUserUID).update({
                followers: firebase.firestore.FieldValue.arrayRemove(currentUserUID),
                followerCount: firebase.firestore.FieldValue.increment(-1)
            });
        }
        // Button will auto-update because loadProfileData uses onSnapshot
    };
</script>

<script src="components/call-notifier.js" defer></script>
<call-notifier></call-notifier>

</body>
</html>